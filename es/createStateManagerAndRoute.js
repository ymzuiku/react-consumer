"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,r=1,a=arguments.length;r<a;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};exports.__esModule=!0;var createRoute_1=require("./createRoute"),createStateManager_1=require("./createStateManager"),queryString_1=require("./queryString");function initPaths(t){if("undefined"==typeof window)return["/"];var e=window.location.pathname;if("/"===e||e===t)return window.history.replaceState(null,t,t),[t];var r=window.location.search;return window.history.replaceState(null,t,t),window.history.pushState(null,e,e+r),[t,e]}function createStateManagerAndRoute(t,e){void 0===e&&(e="/");var r={route:{params:[queryString_1.queryString.parse(window.location.search)],paths:initPaths(e)}};t=__assign({},t,r);function o(t){for(var e=!0,r=s.state,a=r.route.paths[r.route.paths.length-1],n=0,o=h;n<o.length;n++){if(e=(0,o[n])(a,t,s.state))break}return e}function a(e,r,a){o(r)&&s.updateState(function(t){t.route.paths.push(e),t.route.params.push(r||{}),"undefined"==typeof window||a||window.history.pushState(null,e,r?e+"?"+queryString_1.queryString.stringify(r):e)})}function n(t,r){var e=s.state,a=void 0===t?e.route.paths.length-1:t,n=e.route.params[a];o(n)&&s.updateState(function(t){for(var e=0;e<t.route.paths.length-a;e++)r||window.history.back(),t.route.paths.pop(),t.route.params.pop()})}var i=createStateManager_1.createStateManager(t),u=i.Consumer,s=i.store,p=createRoute_1.createRoute(u),h=[];if("undefined"!=typeof window){window.addEventListener("popstate",function(){var t=s.state.route.paths;if(window.location.pathname!==t[t.length-1]){var r=!1;if(t.forEach(function(t,e){t===window.location.pathname&&(r=!0)}),r)n(void 0,!0);else{var e=window.location.search;a(window.location.pathname,""===e?void 0:queryString_1.queryString.parse(e),!0)}}})}var c={back:n,listen:function(t){h.push(t)},push:a,replace:function(e,r){if(o(r)){var t=s.state,a=e||t.route.paths[t.route.paths.length-1];s.updateState(function(t){r&&(t.route.params[t.route.params.length-1]=r),t.route.paths[t.route.paths.length-1]=a,"undefined"!=typeof window&&window.history.replaceState(null,a,r?e+"?"+queryString_1.queryString.stringify(r):a)})}}};return{Consumer:u,store:s,Route:p,dispatchRoute:c}}exports.createStateManagerAndRoute=createStateManagerAndRoute;