"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,a=1,r=arguments.length;a<r;a++)for(var n in e=arguments[a])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};exports.__esModule=!0;var queryString=require("querystring"),createRoute_1=require("./createRoute"),createStateManager_1=require("./createStateManager");function initPaths(t){if("undefined"==typeof window)return["/"];var e=window.location.pathname;if("/"===e||e===t)return window.history.replaceState(null,t,t),[t];var a=window.location.search;return window.history.replaceState(null,t,t),window.history.pushState(null,e,e+a),[t,e]}function createStateManagerAndRoute(t,e){void 0===e&&(e="/");var a={route:{params:[queryString.parse(window.location.search)],paths:initPaths(e)}};t=__assign({},t,a);function o(t){for(var e=!0,a=s.state,r=a.route.paths[a.route.paths.length-1],n=0,o=h;n<o.length;n++){if(e=(0,o[n])(r,t,s.state))break}return e}function r(e,a,r){o(a)&&s.updateState(function(t){t.route.paths.push(e),t.route.params.push(a||{}),"undefined"==typeof window||r||window.history.pushState(null,e,a?e+"?"+queryString.stringify(a):e)})}function n(t,a){var e=s.state,r=void 0===t?e.route.paths.length-1:t,n=e.route.params[r];o(n)&&s.updateState(function(t){for(var e=0;e<t.route.paths.length-r;e++)a||window.history.back(),t.route.paths.pop(),t.route.params.pop()})}var i=createStateManager_1.createStateManager(t),u=i.Consumer,s=i.store,p=createRoute_1.createRoute(u),h=[];if("undefined"!=typeof window){window.addEventListener("popstate",function(){var t=s.state.route.paths;if(window.location.pathname!==t[t.length-1]){var a=!1;if(t.forEach(function(t,e){t===window.location.pathname&&(a=!0)}),a)n(void 0,!0);else{var e=window.location.search;r(window.location.pathname,""===e?void 0:queryString.parse(e),!0)}}})}var c={back:n,listen:function(t){h.push(t)},push:r,replace:function(e,a){if(o(a)){var t=s.state,r=e||t.route.paths[t.route.paths.length-1];s.updateState(function(t){a&&(t.route.params[t.route.params.length-1]=a),t.route.paths[t.route.paths.length-1]=r,"undefined"!=typeof window&&window.history.replaceState(null,r,a?e+"?"+queryString.stringify(a):r)})}}};return{Consumer:u,store:s,Route:p,dispatchRoute:c}}exports.createStateManagerAndRoute=createStateManagerAndRoute;