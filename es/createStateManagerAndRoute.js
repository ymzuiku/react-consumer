"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,r=1,a=arguments.length;r<a;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};exports.__esModule=!0;var createRoute_1=require("./createRoute"),createStateManager_1=require("./createStateManager"),queryString_1=require("./queryString");function initPaths(t){if("undefined"==typeof window)return["/"];var e=window.location.pathname;if("/"===e||e===t)return window.history.replaceState(null,t,t),[t];var r=window.location.search;return window.history.replaceState(null,t,t),window.history.pushState(null,e,e+r),[t,e]}function createStateManagerAndRoute(t,e){void 0===e&&(e="/");var r={route:{params:[queryString_1.queryString.parse(window.location.search)],paths:initPaths(e)}};t=__assign({},t,r);function n(t){for(var e=!0,r=i.state,a=r.route.paths[r.route.paths.length-1],n=0,o=s;n<o.length;n++){if(e=(0,o[n])(a,t,i.state))break}return e}var a=createStateManager_1.createStateManager(t),o=a.Consumer,i=a.store,u=createRoute_1.createRoute(o),s=[],p={back:function(t){var e=i.state,r=t;"number"==typeof t&&void 0!==t||(r=e.route.params.length-1),r=r<0?0:r;var a=e.route.params[r];n(a)&&i.setState(function(t){for(var e=0;e<t.route.paths.length-r;e++)window.history.back(),t.route.paths.pop(),t.route.params.pop()})},listen:function(t){s.push(t)},push:function(e,r){n(r)&&i.setState(function(t){t.route.paths.push(e),r?(t.route.params.push(r),"undefined"!=typeof window&&window.history.pushState(null,e,e+"?"+queryString_1.queryString.stringify(r))):"undefined"!=typeof window&&window.history.pushState(null,e,e)})},replace:function(e){if(n(e)){var t=i.state,r=t.route.paths[t.route.paths.length-1];i.setState(function(t){t.route.params[t.route.params.length-1]=e,"undefined"!=typeof window&&window.history.replaceState(null,r,r+"?"+queryString_1.queryString.stringify(e))})}}};return{Consumer:o,store:i,Route:u,dispatchRoute:p}}exports.createStateManagerAndRoute=createStateManagerAndRoute;