"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,a=1,r=arguments.length;a<r;a++)for(var n in e=arguments[a])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};exports.__esModule=!0;var queryString=require("querystring"),createRoute_1=require("./createRoute"),createStateManager_1=require("./createStateManager");function createStateManagerAndRoute(t,n){t=__assign({},t,{route:{params:[],paths:[]}});function i(t,e){if(!t)return!0;for(var a=!0,r=0,n=p;r<n.length;r++){if(!(a=(0,n[r])(t,e,u.state)))break}return a}function r(e,a,r){i(e,a)&&u.updateState(function(t){t.route.paths.push(e),t.route.params.push(a||{}),"undefined"==typeof window||r||n||window.history.pushState(null,e,a?e+"?"+queryString.stringify(a):e)})}function o(t,a){var e=u.state,r=void 0===t?e.route.paths.length-1:t,n=e.route.paths[r-1],o=e.route.params[r-1];i(n,o)&&u.updateState(function(t){for(var e=0;e<t.route.paths.length-r;e++)a||window.history.back(),t.route.paths.pop(),t.route.params.pop()})}var e=createStateManager_1.createStateManager(t),a=e.Consumer,u=e.store,s=createRoute_1.createRoute(a),p=[];if("undefined"!=typeof window){window.addEventListener("popstate",function(){var t=u.state.route.paths;if(window.location.pathname!==t[t.length-1]){var a=!1;if(t.forEach(function(t,e){t===window.location.pathname&&(a=!0)}),a)o(void 0,!0);else{var e=window.location.search;r(window.location.pathname,""===e?void 0:queryString.parse(e),!0)}}})}var c={initRoute:function(t){if(u.updateState(function(t){t.route={params:[],paths:[]}}),"undefined"!=typeof window){var e=window.location.pathname,a=window.location.search;"/"===e||e===t?r(t):(r(t),r(e,a?queryString.parse(a):void 0))}},listen:function(t){p.push(t)},pop:o,push:r,replace:function(e,a){var t=u.state,r=e||t.route.paths[t.route.paths.length-1];i(r,a)&&u.updateState(function(t){a&&(t.route.params[t.route.params.length-1]=a),t.route.paths[t.route.paths.length-1]=r,"undefined"!=typeof window&&window.history.replaceState(null,r,a?e+"?"+queryString.stringify(a):r)})}};return{Consumer:a,store:u,Route:s,dispatchRoute:c}}exports.createStateManagerAndRoute=createStateManagerAndRoute;