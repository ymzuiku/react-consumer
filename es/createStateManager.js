"use strict";var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();exports.__esModule=!0;var immer_1=require("immer"),React=require("react");function createStateManager(t){var e,n=new Set,a={getState:function(t){if(t)try{return t(a.state)}catch(t){return}return a.state},setState:function(e){a.state=immer_1.default(a.state,function(t){return e(t)}),n.forEach(function(t){t(a.state)})},state:t,subscribes:n},o=(e=React.Component,__extends(r,e),r.prototype.componentDidMount=function(){this.isInited=!0},r.prototype.componentWillUnmount=function(){this.unListen(),this.props.beforeUnmount&&this.props.beforeUnmount(this.lastMemo)},r.prototype.render=function(){return this.props.children(this.lastMemo)},r);function r(t){var i=e.call(this,t)||this;if(i.lastMemo=[],i.isInited=!1,i.handleListen=function(t){for(var e=i.props,n=e.beforeUpdate,o=(0,e.memo)(a.state),r=!1,s=0;s<i.lastMemo.length;s++)if(i.lastMemo[s]!==o[s]){r=!0;break}i.lastMemo=o.slice(),r&&(void 0!==n&&n(o),i.forceUpdate())},i.shouldComponentUpdate=function(){return!1},void 0===i.props.memo)throw new Error('<Consumer /> need "memo" props');return i.lastMemo=i.props.memo(a.state).slice(),i.unListen=function(t){return n.add(t),function(){n.delete(t)}}(i.handleListen),i}return{store:a,Consumer:o}}exports.createStateManager=createStateManager;