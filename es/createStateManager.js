"use strict";var __extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();exports.__esModule=!0;var immer_1=require("immer"),React=require("react");function createStateManager(t){function e(t){return r.add(t),function(){r.delete(t)}}var n,r=new Set,i={listen:e,state:t,subscribes:r,updateState:function(e){i.state=immer_1.default(i.state,function(t){return e(t)}),r.forEach(function(t){t(i.state)})}},o=(n=React.Component,__extends(s,n),s.prototype.componentWillUnmount=function(){this.unListen(),this.props.beforeUnmount&&this.props.beforeUnmount(this.lastMemo)},s.prototype.render=function(){return this.props.children(this.lastMemo,i.state)},s);function s(t){var a=n.call(this,t)||this;if(a.lastMemo=[],a.handleListen=function(t){for(var e=a.props,n=e.beforeUpdate,r=(0,e.memo)(i.state),o=!1,s=0;s<a.lastMemo.length;s++)if(a.lastMemo[s]!==r[s]){o=!0;break}a.lastMemo=r.slice(),o&&(void 0!==n&&n(r),requestAnimationFrame?requestAnimationFrame(function(){return a.forceUpdate()}):a.forceUpdate())},a.shouldComponentUpdate=function(){return!1},void 0===a.props.memo)throw new Error('<Consumer /> need "memo" props');return a.lastMemo=a.props.memo(i.state).slice(),a.unListen=e(a.handleListen),a}return{store:i,Consumer:o}}exports.createStateManager=createStateManager;