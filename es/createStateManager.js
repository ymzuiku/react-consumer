"use strict";var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();exports.__esModule=!0;var immer_1=require("immer"),React=require("react");function createStateManager(t){function e(t){return n.add(t),function(){n.delete(t)}}var r,n=new Set,a={listen:e,state:t,subscribes:n,update:function(e){a.state=immer_1.default(a.state,function(t){return e(t)}),n.forEach(function(t){t(a.state)})}},o=(r=React.Component,__extends(s,r),s.prototype.componentWillUnmount=function(){this.unListen(),this.props.beforeUnmount&&this.props.beforeUnmount(this.lastMemo)},s.prototype.render=function(){var t;return(t=this.props).children.apply(t,this.lastMemo)},s);function s(t){var i=r.call(this,t)||this;if(i.lastMemo=[],i.handleListen=function(t){for(var e=i.props,r=e.beforeUpdate,n=(0,e.subscribe)(a.state),o=!1,s=0;s<i.lastMemo.length;s++)if(i.lastMemo[s]!==n[s]){o=!0;break}i.lastMemo=n.slice(),o&&(void 0!==r&&r(n),i.forceUpdate())},i.shouldComponentUpdate=function(){return!1},void 0===i.props.subscribe)throw new Error('<Consumer /> need "subscrib" props');return i.lastMemo=i.props.subscribe(a.state).slice(),i.unListen=e(i.handleListen),i}return{store:a,Consumer:o}}exports.createStateManager=createStateManager;