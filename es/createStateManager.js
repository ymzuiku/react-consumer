"use strict";var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();exports.__esModule=!0;var immer_1=require("immer"),React=require("react");function createStateManager(t){var e,r=0,n={},u={getState:function(t){if(t)try{return t(u.state)}catch(t){return}return u.state},setState:function(e){for(var t in u.state=immer_1.default(u.state,function(t){return e(t)}),n)n[t](u.state)},state:t,subscribes:n},o=(e=React.Component,__extends(a,e),a.prototype.componentWillUnmount=function(){this.unListen()},a.prototype.render=function(){return this.props.children(u.state)},a);function a(t){var i=e.call(this,t)||this;return i.lastMemo=[],i.handleListen=function(t){var e=i.props,r=e.listen,n=e.memo;if(void 0!==r&&r(t),void 0!==n){if(0===n.length)return;for(var o=n(u.state),a=!1,s=0;s<i.lastMemo.length;s++)if(i.lastMemo[s]!==o[s]){a=!0;break}a&&(i.lastMemo=o.slice(),i.forceUpdate())}else i.forceUpdate()},i.shouldComponentUpdate=function(){return!1},void 0!==i.props.memo&&(i.lastMemo=i.props.memo(u.state).slice()),i.unListen=function(t){999999998<++r&&(r=0);var e=r;return n[e]=t,function(){delete n[e]}}(i.handleListen),i}return{store:u,Consumer:o}}exports.createStateManager=createStateManager;