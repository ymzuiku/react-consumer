"use strict";var __extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();exports.__esModule=!0;var immer_1=require("immer"),React=require("react");function createStateManager(t){var e,n=new Set,i={getState:function(t){if(t)try{return t(i.state)}catch(t){return}return i.state},setState:function(e){i.state=immer_1.default(i.state,function(t){return e(t)}),n.forEach(function(t){t(i.state)})},state:t,subscribes:n},r=(e=React.Component,__extends(o,e),o.prototype.componentDidMount=function(){this.isInited=!0},o.prototype.componentWillUnmount=function(){this.unListen()},o.prototype.render=function(){return this.props.children(this.lastMemo,i.state)},o);function o(t){var s=e.call(this,t)||this;return s.lastMemo=[],s.isInited=!1,s.handleListen=function(t){for(var e=s.props,n=e.beforeUpdate,r=(0,e.memo)(i.state),o=!1,a=0;a<s.lastMemo.length;a++)if(s.lastMemo[a]!==r[a]){o=!0;break}s.lastMemo=r.slice(),o&&(void 0!==n&&n(r,i.state),s.forceUpdate())},s.shouldComponentUpdate=function(){return!1},s.lastMemo=s.props.memo(i.state).slice(),s.unListen=function(t){return n.add(t),function(){n.delete(t)}}(s.handleListen),s}return{store:i,Consumer:r}}exports.createStateManager=createStateManager;