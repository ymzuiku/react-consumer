"use strict";exports.__esModule=!0;var queryString=require("querystringify"),_createRoute_1=require("./_createRoute");function bindRouteManager(t,i,a){i.updateState(function(t){t.route={params:[],paths:[]}});function u(t,e){if(!t)return!0;for(var n=!0,o=0,a=p;o<a.length;o++){if(!(n=(0,a[o])(t,e,i.state)))break}return n}function o(e,n,o){u(e,n)&&i.updateState(function(t){t.route.paths.push(e),t.route.params.push(n||{}),"undefined"==typeof window||o||a||window.history.pushState(null,e,n?e+"?"+queryString.stringify(n):e)})}function r(t,n){var e=i.state,o=void 0===t?e.route.paths.length-1:t,a=e.route.paths[o-1],r=e.route.params[o-1];u(a,r)&&i.updateState(function(t){for(var e=0;e<t.route.paths.length-o;e++)n||window.history.back(),t.route.paths.pop(),t.route.params.pop()})}var e=_createRoute_1.createRoute(t),p=[];if("undefined"!=typeof window){window.addEventListener("popstate",function(){var t=i.state.route.paths;if(window.location.pathname!==t[t.length-1]){var n=!1;if(t.forEach(function(t,e){t===window.location.pathname&&(n=!0)}),n)r(void 0,!0);else{var e=window.location.search;o(window.location.pathname,""===e?void 0:queryString.parse(e),!0)}}})}var n={initRoute:function(t){if(i.updateState(function(t){t.route={params:[],paths:[]}}),"undefined"!=typeof window){var e=window.location.pathname,n=window.location.search;"/"===e||e===t?o(t):(o(t),o(e,n?queryString.parse(n):void 0))}},listen:function(t){p.push(t)},pop:r,push:o,replace:function(e,n){var t=i.state,o=e||t.route.paths[t.route.paths.length-1];u(o,n)&&i.updateState(function(t){n&&(t.route.params[t.route.params.length-1]=n),t.route.paths[t.route.paths.length-1]=o,"undefined"!=typeof window&&window.history.replaceState(null,o,n?e+"?"+queryString.stringify(n):o)})}};return{Consumer:t,store:i,Route:e,dispatchRoute:n}}exports.bindRouteManager=bindRouteManager;