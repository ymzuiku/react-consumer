"use strict";var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var n=Array(t),a=0;for(e=0;e<r;e++)for(var o=arguments[e],s=0,i=o.length;s<i;s++,a++)n[a]=o[s];return n};exports.__esModule=!0;var immer_1=require("immer"),preact_1=require("preact");function createStateManager(t){function e(t){return n.add(t),function(){n.delete(t)}}var r,n=new Set,a=t,i={listen:e,getState:function(){return a},subscribes:n,update:function(e){a=immer_1.default(i.getState(),function(t){e(t)}),n.forEach(function(t){t(a)})}},o=(r=preact_1.Component,__extends(s,r),s.prototype.componentWillUnmount=function(){this.unListen&&(this.unListen(),this.unListen=null),this.props.beforeUnmount&&this.props.beforeUnmount(this.lastData)},s.prototype.render=function(){var t;return(t=this.props).children.apply(t,this.lastData)},s);function s(t){var s=r.call(this,t)||this;return s.lastData=[],s.state={num:0},s.unListen=null,s.handleListen=function(t){for(var e=s.props,r=e.beforeUpdate,n=(0,e.subscribe)(i.getState()),a=!1,o=0;o<s.lastData.length;o++)if(s.lastData[o]!==n[o]){a=!0;break}s.lastData=__spreadArrays(n),a&&(void 0!==r&&r(n),s.setState(function(t){var e=t.num;return{num:900<e?1:e+1}}))},s.shouldComponentUpdate=function(t,e){if(e.num!==s.state.num)return!0;if(t.memo){for(var r=s.props.memo,n=!1,a=0;a<r.length;a++)if(t.memo[a]!==r[a]){n=!0;break}return n}return!1},s.props.subscribe&&(s.lastData=__spreadArrays(s.props.subscribe(i.getState())),s.unListen=e(s.handleListen)),s}return{store:i,Consumer:o}}exports.createStateManager=createStateManager;